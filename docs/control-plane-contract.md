# 控制面契约（Control Plane Contract）

本文档定义 **控制面（Orchestrator）** 与 **数据面入口（ProxySQL）**
在本项目中的**职责边界、状态输入输出以及交互契约**。

本文档的目标是确保：

- 控制决策只有一个来源
- 数据入口只做执行，不做判断
- 系统状态变化是显式、可追溯、可推理的

> 本文档是实现 ProxySQL / Orchestrator 配置与脚本的直接约束。
> 若实现行为与本文档冲突，应以本文档为准并修正实现。

---

## 1. 控制面与数据面的角色划分

### 1.1 控制面（Control Plane）

**控制面唯一实现者：Orchestrator**

控制面的职责是：

- 感知数据库拓扑与复制状态
- 判定“当前事实状态”
- 在满足 Quorum 前提下做出切换决策
- 触发 fencing，防止脑裂

控制面 **不直接承载业务流量**。

---

### 1.2 数据面（Data Plane）

**数据面入口：ProxySQL**

数据面的职责是：

- 接收应用请求
- 根据“已确认事实”进行路由或拒绝
- 不推断、不猜测、不补偿

数据面 **不参与拓扑判断**。

---

## 2. 核心设计原则（必须遵守）

1. **单一事实源（Single Source of Truth）**  
   - 拓扑与主从事实只能来自 Orchestrator

2. **决策与执行分离**  
   - Orchestrator 决定“应该怎样”
   - ProxySQL 只执行“已经决定的事实”

3. **无隐式状态**  
   - 不允许 ProxySQL 根据探测结果自行改变写策略
   - 不允许数据库节点自行宣称角色

4. **失败显式化**  
   - 当状态不确定时，必须拒绝写，而不是尝试“自愈”

---

## 3. Orchestrator 的“事实模型”（Fact Model）

Orchestrator 对外提供的不是“推测”，而是**事实快照**。

### 3.1 Orchestrator 必须明确表达的事实

至少包括以下信息：

| 事实项 | 含义 |
|---|---|
| current_primary | 当前被认可的 Primary 节点 |
| primary_reachable | Primary 是否可达 |
| quorum_available | 是否满足决策 Quorum |
| write_condition | 是否满足写条件（ACK ≥ 1） |
| topology_version | 当前拓扑版本号（单调递增） |

> 实现方式可以是 API、DB 表、KV、文件或 hook 输出，
> 但语义必须完整、明确、可读取。

---

### 3.2 Orchestrator 的状态判定原则

- **无 Quorum → 不切主**
- **状态不确定 → 不切主**
- **切主前必须确认 fencing 可执行**
- **切主后必须发布新的事实快照**

Orchestrator 允许“不作为”，但不允许“猜测”。

---

## 4. ProxySQL 的输入契约（Allowed Inputs）

ProxySQL **只能**基于以下输入做决定：

1. Orchestrator 发布的当前事实
2. 明确配置的静态规则（如：读写分离策略）

ProxySQL **不得**基于：

- 自己的后端探测结果推断主
- 数据库节点的自我声明
- 历史状态进行“猜测恢复”

---

## 5. ProxySQL 的行为契约（Execution Rules）

### 5.1 写请求处理规则

ProxySQL 在接收到写请求时：

1. 检查是否存在 **明确的 current_primary**
2. 检查 write_condition 是否为 true
3. 若任一条件不满足：
   - **必须拒绝写请求**
   - 返回明确错误（而非超时等待）

### 5.2 读请求处理规则

ProxySQL 在接收到读请求时：

- 可路由至任意被标记为可读的节点
- 读路由策略不影响一致性语义
- 读失败不得触发任何主判定行为

---

## 6. 状态变化与收敛顺序（非常重要）

在发生主切换时，必须遵循以下顺序：

1. Orchestrator 确认满足 Quorum
2. Orchestrator 选择候选主
3. Orchestrator 触发 fencing（隔离旧主）
4. Orchestrator 提升新主
5. Orchestrator 发布新的事实快照
6. ProxySQL 感知事实变化并收敛路由

> 禁止顺序颠倒，尤其禁止：
> - 未 fencing 即开放新主写
> - ProxySQL 在事实未确认前切写

---

## 7. Fencing 的控制面语义

fencing 属于 **控制面行为**，但其结果必须体现在“事实模型”中。

fencing 成功的最小判定标准是：

- 旧 Primary 无法再被 ProxySQL 路由到写
- 旧 Primary 即使存活，也无法接受新写请求

fencing 的具体实现方式不在本契约中限定，
但其**效果是强制性的**。

---

## 8. 异常与边界状态处理

### 8.1 Orchestrator 不可用

- 系统进入“无控制面更新”状态
- ProxySQL 必须：
  - 继续使用最近一次确认的事实
  - **不得自行切主**
- 若当前事实已不满足写条件：
  - 必须拒绝写

---

### 8.2 ProxySQL 不可用

- 不影响数据库拓扑正确性
- 仅影响业务入口
- 不得触发任何控制面决策变化

---

## 9. 与失败语义的一致性约束

本控制面契约必须满足：

- 不引入 `failure-semantics.md` 中未定义的新行为
- 不削弱任何拒写条件
- 不提供“例外路径”绕过 Quorum 或 fencing

若发现控制面实现需要“特判”才能工作，
应优先检查设计是否违反失败语义规范。

---

## 10. 总结

本项目的控制面契约可以概括为：

> **控制面只发布事实，不发布建议；  
> 数据面只执行事实，不做推断。**

这不是限制灵活性，而是确保在复杂失败条件下，
系统行为仍然是**唯一、可解释、可复盘的**。

---
