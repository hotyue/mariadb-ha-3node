# 节点职责契约（Node Responsibilities）

本文档把 `docs/failure-semantics.md` 中的“系统级失败语义”拆解为：
- 各节点（Node-1/2/3）在不同状态下的**权利与义务**
- ProxySQL / Orchestrator 的**权限边界**
- 任何实现必须遵循的**不可越权规则**

> 本文档是实现层（compose、配置、脚本）的直接依据。
> 若实现与本文档冲突，应以本文档为准，并修正实现。

---

## 1. 角色与命名

### 1.1 数据库节点

| 节点 | 默认角色 | 说明 |
|---|---|---|
| Node-1 | Primary | 唯一写节点（正常态） |
| Node-2 | Replica | 从节点（正常态） |
| Node-3 | Replica（中立） | 从节点 + Quorum 见证点（正常态） |

说明：
- 任一时刻，只允许 **一个 Primary**
- Replica 允许提供只读服务（视业务策略）

### 1.2 控制与路由组件

- **Orchestrator**：拓扑感知、故障切换、fencing 触发者（控制面）
- **ProxySQL**：读写路由与快速拒绝（数据面入口）

---

## 2. 全局不变量（必须永远成立）

以下不变量是本项目的“硬约束”，任何节点/组件不得违反：

1. **单主不变量**：任一时刻最多存在 1 个对外可写的 Primary
2. **写入 Quorum 不变量**：写入必须满足“ACK ≥ 1（半同步）”
3. **无静默降级不变量**：不得在故障时隐式降级为异步以继续写
4. **显式失败不变量**：当不满足写条件时，必须明确拒绝写入
5. **防脑裂不变量**：在网络分区或 Quorum 不确定时，宁可拒写也不允许双主写

---

## 3. 节点状态模型（用于推导职责）

为描述行为，本项目定义节点可见性与写条件：

- **可见性（Reachability）**：节点间网络连通且复制/探测可正常进行
- **写条件（Writable Condition）**：Primary 与至少 1 个 Replica 可完成半同步 ACK

对任何节点而言，状态可归纳为：

- Healthy：服务正常
- Suspect：探测异常（短暂抖动/不确定）
- Isolated：无法与多数节点互相验证
- Down：节点不可用

实现可使用不同探测方式，但输出语义必须可归入以上范畴。

---

## 4. Node-1（Primary）职责

### 4.1 正常态职责（满足写条件）

当 Node-1 为 Primary 且满足写条件（ACK ≥ 1）时：

- 必须允许写入（通过 ProxySQL 对外开放写）
- 必须持续输出复制状态与 GTID 进度供 Orchestrator 判断
- 不得向外宣称任何其他节点为 Primary

### 4.2 写条件不满足时的职责（核心）

当 Node-1 仍存活，但无法与任何 Replica 完成 ACK（ACK = 0）时：

- **必须停止对外写入**
- 允许继续提供只读（是否对外暴露由 ProxySQL 策略决定）
- 不得尝试“自行降级异步继续写”
- 必须接受 fencing（被隔离）为合法手段

> 说明：此处的“停止对外写入”应由 ProxySQL 入口快速拒绝实现，
> 而不是依赖数据库线程无限等待导致资源耗尽。

### 4.3 网络分区时的职责（防脑裂）

若 Node-1 与其他节点发生网络分区，且无法确认自身处于多数派：

- 必须进入“拒绝写”状态
- 不得在分区期间继续写入
- 等待 Orchestrator 依据多数派做出最终判定

---

## 5. Node-2（Replica）职责

### 5.1 正常态职责

作为 Replica：

- 必须保持只读（read_only / super_read_only 语义等价）
- 必须持续追赶 Primary 复制流
- 必须对外可提供只读查询（是否启用由 ProxySQL 决定）
- 必须向 Orchestrator 汇报复制延迟、GTID 位置、健康状态

### 5.2 作为候选主的职责（Promotion Candidate）

当 Orchestrator 决定将 Node-2 提升为 Primary 时：

- 只允许在 **满足决策 Quorum** 的前提下提升
- 提升后必须：
  - 解除只读（对外可写）
  - 建立新的复制拓扑（其他节点向其复制）
- 提升动作不得由 Node-2 自行触发（禁止自作主张）

### 5.3 不确定/孤岛状态职责

当 Node-2 无法与 Orchestrator/多数节点建立一致视图时：

- 必须保持只读
- 不得对外开放写入
- 不得“自认为主”或进行任何主宣告

---

## 6. Node-3（Replica + 中立 Quorum 见证）职责

Node-3 在职责上类似 Node-2，但有额外要求：

### 6.1 中立性要求

- Node-3 不得被设计为“默认主”
- Node-3 的首要价值是：
  - 为多数派决策提供中立参照
  - 为半同步提供第二 ACK 来源（冗余）

### 6.2 正常态职责

- 保持只读
- 保持复制追赶
- 提供可靠健康信号与 GTID 位置
- 尽可能稳定（资源隔离、降低抖动源）

### 6.3 作为候选主的职责

在满足 Quorum 且 Node-3 GTID 最新时，Node-3 允许被提升为 Primary。

但必须满足：
- 由 Orchestrator 明确触发
- fencing 已对旧主生效或被确认失效
- ProxySQL 写路由切换在提升后执行（避免双写窗口）

---

## 7. Orchestrator 职责（控制面）

Orchestrator 是唯一允许做出以下决策的组件：

1. **判定当前 Primary**
2. **选择并执行故障切换（failover）**
3. **选择最合适的候选主（基于 GTID、延迟、健康状态）**
4. **触发 fencing**（隔离旧主，防止双主写）

Orchestrator 必须遵守：

- 无 Quorum 不切主
- 不确定状态不切主
- 切主必须可解释（应记录原因与依据）

---

## 8. ProxySQL 职责（数据面入口）

ProxySQL 不做“主是谁”的决策，只做以下事：

1. **将写流量路由到 Orchestrator 标记的 Primary**
2. **将读流量路由到可用 Replica（策略可配）**
3. **在写条件不满足时快速拒绝写请求**
4. **在主切换后快速收敛路由**

ProxySQL 必须遵守：

- 没有明确 Primary 时，写请求必须失败（拒绝写）
- 不得“猜测”某个节点为主
- 不得在故障时将写流量广播或轮询到多个节点

---

## 9. Fencing（隔离）语义

fencing 是防脑裂的关键措施，定义如下：

- 当 Orchestrator 判定旧 Primary 不可信或已失联时，
  必须触发 fencing，使其**无法再对外提供写服务**。

fencing 可通过多种实现达成（网络隔离、代理层封禁、主机层规则等），但语义必须满足：

- 旧主不能再被应用写入
- 旧主即使恢复，也必须先回到 Replica 身份，等待人工或自动再整合

---

## 10. 场景到职责的映射（摘要）

| 场景 | Node-1 | Node-2 | Node-3 | ProxySQL | Orchestrator |
|---|---|---|---|---|---|
| 全健康 | 写 | 读 | 读 | 正常路由 | 监控 |
| 主宕机（2 从存活） | Down | 候选主 | 候选主 | 暂拒写→收敛 | 选主+切换+fencing |
| ACK=0 | 拒写 | 读 | 读 | 拒写 | 保持/告警 |
| 网络分区 | 拒写 | 只读 | 只读 | 拒写（无明确主） | 多数派判定 |

---

## 11. 实现一致性要求

任何实现（compose、配置、脚本、健康检查）必须满足：

- 不能引入新的“隐式状态”
- 不能产生“灰区主”
- 不能在故障时改变一致性语义

若需要新增状态（例如 maintenance 模式），必须先在本文档中定义其语义与边界。

---
