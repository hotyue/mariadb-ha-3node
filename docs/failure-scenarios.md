# 失败场景演练（Failure Scenarios）

本文档以**时间线演练（playbook）**的方式，描述系统在典型与极端故障下的**期望行为**。
所有演练均以以下前提为基础：

- 三节点 MariaDB：Node-1（Primary）、Node-2（Replica）、Node-3（Replica + 中立 Quorum）
- 半同步复制，写入 ACK ≥ 1
- 不自动降级一致性
- 失败时宁可拒绝写，也不允许写错

> 本文档用于验证：  
> **实现是否严格遵循 `failure-semantics.md` 与 `node-responsibilities.md`。**

---

## 0. 术语与状态约定

- **写可用**：应用可成功提交写事务
- **读可用**：应用可成功执行只读查询
- **拒写**：写请求被快速拒绝（非阻塞等待）
- **Quorum 满足**：至少 2 个节点彼此可见，用于决策；写 ACK ≥ 1
- **稳定态**：系统已收敛到确定角色分配

---

## 场景 1：全节点健康（基线场景）

### 初始状态
- Node-1：Primary（写）
- Node-2：Replica（读）
- Node-3：Replica（读）
- 半同步 ACK 正常

### 期望行为
- 写可用：是
- 读可用：是
- ProxySQL：写 → Node-1；读 → Node-2/3
- Orchestrator：仅监控，无动作

---

## 场景 2：Primary 宕机（标准切主）

### 时间线
- T0：Node-1 突然宕机（进程退出/主机断电）
- T1：Node-2、Node-3 均存活，彼此可见
- T2：Orchestrator 侦测到 Primary 不可达
- T3：Orchestrator 在满足 Quorum 前提下选择候选主
- T4：完成提升与 fencing，ProxySQL 收敛路由

### 期望行为
- T0–T3：写不可用（拒写），读可用
- T4 后：写可用（新主），读可用
- 无双主、无回滚、无人工介入

---

## 场景 3：Primary 宕机，仅 1 个 Replica 存活

### 时间线
- T0：Node-1 宕机
- T1：Node-2 宕机
- T2：仅 Node-3 存活

### 期望行为
- 写可用：否
- 读可用：是（Node-3）
- Orchestrator：不得切主（无 Quorum）
- ProxySQL：明确拒绝写

> 说明：  
> 单节点无法证明自身为“唯一真相”，拒写是唯一合法行为。

---

## 场景 4：任意 1 个 Replica 宕机

### 时间线
- T0：Node-2 宕机
- T1：Node-1 ↔ Node-3 正常

### 期望行为
- 写可用：是（ACK 仍可来自 Node-3）
- 读可用：是（Node-3）
- Orchestrator：记录降级但不切主
- 系统进入“降级但可写”的稳定态

---

## 场景 5：两个 Replica 同时不可达

### 时间线
- T0：Node-2、Node-3 同时宕机或网络不可达
- T1：Node-1 仍存活，但 ACK = 0

### 期望行为
- 写可用：否
- 读可用：是（Node-1 本地读，是否暴露由策略决定）
- Node-1：必须拒绝写（不允许降级异步）
- ProxySQL：拒绝写

---

## 场景 6：Primary 与 Replica 发生网络分区（孤岛主）

### 时间线
- T0：Node-1 ↔ Node-2/3 网络断
- T1：Node-2 ↔ Node-3 正常
- T2：形成两侧视图不一致

### 期望行为
- Node-1：拒绝写（无法确认 Quorum）
- Node-2/3：保持只读
- Orchestrator：以多数派（Node-2 + Node-3）为准
- 若需切主，仅在 fencing 后执行

> 核心目标：  
> **任何时刻不允许两个节点同时对外可写。**

---

## 场景 7：机房 A 整体不可达（含 Primary）

### 时间线
- T0：机房 A 网络/电力中断（Node-1 下线）
- T1：Node-2、Node-3 存活并互通
- T2：Orchestrator 在存活侧执行切主

### 期望行为
- 写可用：短暂不可用 → 恢复
- 读可用：始终可用
- 新 Primary 在机房 B/中立点产生
- 原机房恢复后，旧主只能以 Replica 身份回归

---

## 场景 8：中立节点（Node-3）网络抖动

### 时间线
- T0：Node-3 网络抖动/高延迟
- T1：Node-1 ↔ Node-2 正常

### 期望行为
- 写可用：是（ACK 来自 Node-2）
- 读可用：是
- Orchestrator：记录 Node-3 不稳定，但不触发切主

---

## 场景 9：Quorum 丢失（任意原因）

### 时间线
- T0：节点存活情况不确定 / 探测冲突
- T1：无法形成稳定多数派

### 期望行为
- 写可用：否
- 读可用：可选
- ProxySQL：拒绝写
- Orchestrator：不做任何切换动作，仅告警

---

## 场景 10：节点恢复与重新加入

### 时间线
- T0：故障节点恢复上线
- T1：以 Replica 身份加入拓扑
- T2：完成追赶与一致性校验

### 期望行为
- 恢复节点 **不得** 自动成为 Primary
- 必须等待 Orchestrator 明确角色分配
- 在确认一致性前，不得对外写

---

## 11. 场景完备性说明

上述场景覆盖：

- 单点故障
- 多点组合故障
- 网络分区
- 机房级灾难
- 恢复与再加入

任一真实故障，均应可映射到上述某一或多一场景的组合。

---

## 12. 结论

本项目的失败场景设计遵循以下原则：

- **失败可推演**
- **行为可预测**
- **结果可解释**
- **数据不可被悄悄破坏**

任何实现若在上述演练中表现出不同行为，
应被视为 **设计缺陷或实现错误**，而非“特殊情况”。

---
